/*

smtp_utf8_qp_msg.cpp
--------------------

Connects to an SMTP server and sends a message with UTF8 content and subject.


Copyright (C) 2025, Sylvain Guinebert (github.com/sguinebert).

Distributed under the MIT license, see the accompanying file LICENSE or
copy at https://opensource.org/licenses/MIT.

*/


#include <iostream>
#include <boost/asio.hpp>
#include <boost/asio/co_spawn.hpp>
#include <boost/asio/detached.hpp>
#include <boost/asio/ssl.hpp>
#include <boost/asio/use_awaitable.hpp>
#include "example_util.hpp"
#include <mailxx/mime/message.hpp>
#include <mailxx/mime/mime.hpp>
#include <mailxx/net/tls_mode.hpp>
#include <mailxx/smtp/client.hpp>


using mailxx::codec;
using mailxx::string_t;
using mailxx::message;
using mailxx::mail_address;
using mailxx::mime;
using mailxx::smtp::auth_method;
using mailxx::smtp::client;


int main()
{
    boost::asio::io_context io_ctx;
    boost::asio::ssl::context ssl_ctx(boost::asio::ssl::context::tls_client);

    boost::asio::co_spawn(io_ctx,
        [&]() -> boost::asio::awaitable<void>
        {
            // create mail message
            message msg;
            msg.from(mail_address(string_t("mailxx library", "ASCII", codec::codec_t::BASE64), "mailxx@mailserver.com"));// set the correct sender name and address
            msg.add_recipient(mail_address(string_t("mailxx library", "ASCII", codec::codec_t::BASE64), "mailxx@gmail.com"));// set the correct recipent name and address
            msg.add_recipient(mail_address(string_t("mailxx library", "ASCII", codec::codec_t::BASE64), "mailxx@outlook.com"));// add more recipients
            msg.add_cc_recipient(mail_address(string_t("mailxx library", "ASCII", codec::codec_t::BASE64), "mailxx@yahoo.com"));// add CC recipient
            msg.add_bcc_recipient(mail_address(string_t("mailxx library", "ASCII", codec::codec_t::BASE64), "mailxx@zoho.com"));

            msg.subject("smtp utf8 quoted printable message");
            // create message in Cyrillic alphabet
            // set Transfer Encoding to Quoted Printable and set Content Type to UTF8
            msg.content_transfer_encoding(mime::content_transfer_encoding_t::QUOTED_PRINTABLE);
            msg.content_type(message::media_type_t::TEXT, "plain", "utf-8");

            msg.content(
                u8"??? ?? ???? ??????? ?????? ???? ??? ? ??????? ?????? ? ??????????? ??????. ???? ????? ???? ?? ?? ????? ?????????\r\n"
                u8"?? ?? ????? ?? ?? ?? ???? ????? ????????.\r\n"
                u8"\r\n"
                u8"????? ?????? ???? ??????? ???? ???????? ???? ?????, ?? ??\r\n"
                u8"?????? ???? ???????? ??????????? ?????. ? ????? ? ???? ???????, ??? libmailxx ???? ???????? ?? ??\r\n"
                u8"???? ???????????? ??????.\r\n"
                u8"\r\n\r\n"
                u8"? ?????? ???????, ????? ??????? ???????? ????? ??????? ? ??????? utf8 ????????? ???. ????????\r\n"
                u8"? ?????? ???? ?? ??????? ????? ???? ?? ????????? ??????????. ??????? ?? ?? ?? ??????? ?? ?? ?? ????????\r\n"
                u8"base64 ??? quoted printable, ??? ?? ascii ????????? ????????? ? ???? ??????. ???? ???? ?? ??????? ??\r\n"
                u8"?????? ??? ?? ?????? ? ?????? ???????????,\r\n"
                u8"? ???? ?? ????? ????????? ?? ??????????.\r\n"
                u8"\r\n\r\n\r\n\r\n"
                u8"???? ?? ? ??????? ?? ??? ??????? ??????.");

            // connect using STARTTLS
            mailxx::smtp::options options;
            options.tls.use_default_verify_paths = true;
            options.tls.verify = mailxx::net::verify_mode::peer;
            options.tls.verify_host = true;
            options.auto_starttls = true;

            client conn(io_ctx.get_executor(), options);
            if (auto connect_res = co_await conn.connect("smtp.mailserver.com", "587",
                mailxx::net::tls_mode::starttls, &ssl_ctx, "smtp.mailserver.com"); !connect_res)
            {
                print_error(connect_res.error());
                co_return;
            }
            // modify username/password to use real credentials
            if (auto auth_res = co_await conn.authenticate("mailxx@mailserver.com", "mailxxpass", auth_method::login); !auth_res)
            {
                print_error(auth_res.error());
                co_return;
            }
            if (auto send_res = co_await conn.send(msg); !send_res)
            {
                print_error(send_res.error());
                co_return;
            }
            if (auto quit_res = co_await conn.quit(); !quit_res)
            {
                print_error(quit_res.error());
                co_return;
            }
            co_return;
        },
        boost::asio::detached);

    io_ctx.run();
    return EXIT_SUCCESS;
}
